{"version":3,"file":"lazy-chunk-TransportWebAuthn.es.js","sources":["source-mapped://source-mapped/node_modules/@ledgerhq/devices/src/scrambling.js","source-mapped://source-mapped/node_modules/@ledgerhq/hw-transport-webauthn/src/TransportWebAuthn.js"],"sourcesContent":["// @flow\n\nexport function wrapApdu(apdu: Buffer, key: Buffer) {\n  if (apdu.length === 0) return apdu;\n  const result = Buffer.alloc(apdu.length);\n  for (let i = 0; i < apdu.length; i++) {\n    result[i] = apdu[i] ^ key[i % key.length];\n  }\n  return result;\n}\n","//@flow\n\nimport Transport from \"@ledgerhq/hw-transport\";\nimport { TransportError } from \"@ledgerhq/errors\";\nimport { wrapApdu } from \"@ledgerhq/devices/lib/scrambling\";\nimport { log } from \"@ledgerhq/logs\";\n\nconst attemptExchange = (\n  apdu: Buffer,\n  timeout: number,\n  scrambleKey: ?Buffer\n): Promise<Buffer> => {\n  if (!scrambleKey) {\n    throw new TransportError(\n      \"transport.setScrambleKey must be used to set a scramble key. Refer to documentation.\",\n      \"NoScrambleKey\"\n    );\n  }\n\n  if (!navigator.credentials) {\n    throw new TransportError(\"WebAuthn not supported\", \"NotSupported\");\n  }\n\n  return (\n    navigator.credentials\n      // $FlowFixMe\n      .get({\n        publicKey: {\n          timeout,\n          challenge: new Uint8Array(32),\n          allowCredentials: [\n            {\n              type: \"public-key\",\n              id: new Uint8Array(wrapApdu(apdu, scrambleKey)),\n            },\n          ],\n        },\n      })\n      // $FlowFixMe\n      .then((r) => Buffer.from(r.response.signature))\n  );\n};\n\n/**\n * WebAuthn Transport implementation\n * @example\n * import TransportWebAuthn from \"@ledgerhq/hw-transport-webauthn\";\n * ...\n * TransportWebAuthn.create().then(transport => ...)\n */\nexport default class TransportWebAuthn extends Transport<null> {\n  static isSupported = () => Promise.resolve(!!navigator.credentials);\n\n  /*\n   */\n  static list = (): * => (navigator.credentials ? [null] : []);\n\n  /*\n   */\n  static listen = (observer: *) => {\n    setTimeout(() => {\n      if (!navigator.credentials) {\n        observer.error(\n          new TransportError(\"WebAuthn not supported\", \"NotSupported\")\n        );\n        return { unsubscribe: () => {} };\n      }\n      observer.next({ type: \"add\", descriptor: null });\n      observer.complete();\n    }, 0);\n    return { unsubscribe: () => {} };\n  };\n\n  scrambleKey: ?Buffer;\n\n  static async open(): Promise<TransportWebAuthn> {\n    return new TransportWebAuthn();\n  }\n\n  /**\n   * Exchange with the device using APDU protocol.\n   * @param apdu\n   * @returns a promise of apdu response\n   */\n  async exchange(apdu: Buffer): Promise<Buffer> {\n    log(\"apdu\", \"=> \" + apdu.toString(\"hex\"));\n    const res = await attemptExchange(\n      apdu,\n      this.exchangeTimeout,\n      this.scrambleKey\n    );\n    log(\"apdu\", \"<= \" + res.toString(\"hex\"));\n    return res;\n  }\n\n  /**\n   * A scramble key is a string that xor the data exchanged.\n   * It depends on the device app you need to exchange with.\n   * For instance it can be \"BTC\" for the bitcoin app, \"B0L0S\" for the dashboard.\n   *\n   * @example\n   * transport.setScrambleKey(\"B0L0S\")\n   */\n  setScrambleKey(scrambleKey: string) {\n    this.scrambleKey = Buffer.from(scrambleKey, \"ascii\");\n  }\n\n  close(): Promise<void> {\n    return Promise.resolve();\n  }\n}\n"],"names":["wrapApdu","apdu","key","length","result","Buffer","alloc","i","attemptExchange","timeout","scrambleKey","TransportError","navigator","credentials","get","publicKey","challenge","Uint8Array","allowCredentials","type","id","then","r","from","response","signature","TransportWebAuthn","Transport","open","exchange","log","toString","res","exchangeTimeout","setScrambleKey","close","Promise","resolve","isSupported","list","listen","observer","setTimeout","error","unsubscribe","next","descriptor","complete"],"mappings":"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"}