{"version":3,"file":"lazy-chunk-TransportWebUSB.es.js","sources":["source-mapped://source-mapped/node_modules/@ledgerhq/hw-transport-webusb/src/webusb.ts","source-mapped://source-mapped/node_modules/@ledgerhq/hw-transport-webusb/src/TransportWebUSB.ts"],"sourcesContent":["import { ledgerUSBVendorId } from \"@ledgerhq/devices\";\n\nconst ledgerDevices = [\n  {\n    vendorId: ledgerUSBVendorId,\n  },\n];\n\nexport async function requestLedgerDevice(): Promise<USBDevice> {\n  const device = await navigator.usb.requestDevice({\n    filters: ledgerDevices,\n  });\n  return device;\n}\n\nexport async function getLedgerDevices(): Promise<USBDevice[]> {\n  const devices = await navigator.usb.getDevices();\n  return devices.filter(d => d.vendorId === ledgerUSBVendorId);\n}\n\nexport async function getFirstLedgerDevice(): Promise<USBDevice> {\n  const existingDevices = await getLedgerDevices();\n  if (existingDevices.length > 0) return existingDevices[0];\n  return requestLedgerDevice();\n}\n\nexport const isSupported = (): Promise<boolean> =>\n  Promise.resolve(!!navigator && !!navigator.usb && typeof navigator.usb.getDevices === \"function\");\n","import Transport from \"@ledgerhq/hw-transport\";\nimport type { Observer, DescriptorEvent, Subscription } from \"@ledgerhq/hw-transport\";\nimport hidFraming from \"@ledgerhq/devices/hid-framing\";\nimport { identifyUSBProductId } from \"@ledgerhq/devices\";\nimport type { DeviceModel } from \"@ledgerhq/devices\";\nimport { log } from \"@ledgerhq/logs\";\nimport {\n  TransportOpenUserCancelled,\n  TransportInterfaceNotAvailable,\n  TransportWebUSBGestureRequired,\n  DisconnectedDeviceDuringOperation,\n  DisconnectedDevice,\n} from \"@ledgerhq/errors\";\nimport { getLedgerDevices, getFirstLedgerDevice, requestLedgerDevice, isSupported } from \"./webusb\";\n\nconst configurationValue = 1;\nconst endpointNumber = 3;\n\n/**\n * WebUSB Transport implementation\n * @example\n * import TransportWebUSB from \"@ledgerhq/hw-transport-webusb\";\n * ...\n * TransportWebUSB.create().then(transport => ...)\n */\nexport default class TransportWebUSB extends Transport {\n  device: USBDevice;\n  deviceModel: DeviceModel | null | undefined;\n  channel = Math.floor(Math.random() * 0xffff);\n  packetSize = 64;\n  interfaceNumber: number;\n\n  constructor(device: USBDevice, interfaceNumber: number) {\n    super();\n    this.device = device;\n    this.interfaceNumber = interfaceNumber;\n    this.deviceModel = identifyUSBProductId(device.productId);\n  }\n\n  /**\n   * Check if WebUSB transport is supported.\n   */\n  static isSupported = isSupported;\n\n  /**\n   * List the WebUSB devices that was previously authorized by the user.\n   */\n  static list = getLedgerDevices;\n\n  /**\n   * Actively listen to WebUSB devices and emit ONE device\n   * that was either accepted before, if not it will trigger the native permission UI.\n   *\n   * Important: it must be called in the context of a UI click!\n   */\n  static listen = (observer: Observer<DescriptorEvent<USBDevice>>): Subscription => {\n    let unsubscribed = false;\n    getFirstLedgerDevice().then(\n      device => {\n        if (!unsubscribed) {\n          const deviceModel = identifyUSBProductId(device.productId);\n          observer.next({\n            type: \"add\",\n            descriptor: device,\n            deviceModel,\n          });\n          observer.complete();\n        }\n      },\n      error => {\n        if (window.DOMException && error instanceof window.DOMException && error.code === 18) {\n          observer.error(new TransportWebUSBGestureRequired(error.message));\n        } else {\n          observer.error(new TransportOpenUserCancelled(error.message));\n        }\n      },\n    );\n\n    function unsubscribe() {\n      unsubscribed = true;\n    }\n\n    return {\n      unsubscribe,\n    };\n  };\n\n  /**\n   * Similar to create() except it will always display the device permission (even if some devices are already accepted).\n   */\n  static async request() {\n    const device = await requestLedgerDevice();\n    return TransportWebUSB.open(device);\n  }\n\n  /**\n   * Similar to create() except it will never display the device permission (it returns a Promise<?Transport>, null if it fails to find a device).\n   */\n  static async openConnected() {\n    const devices = await getLedgerDevices();\n    if (devices.length === 0) return null;\n    return TransportWebUSB.open(devices[0]);\n  }\n\n  /**\n   * Create a Ledger transport with a USBDevice\n   */\n  static async open(device: USBDevice) {\n    await device.open();\n\n    if (device.configuration === null) {\n      await device.selectConfiguration(configurationValue);\n    }\n\n    await gracefullyResetDevice(device);\n    const iface = device.configurations[0].interfaces.find(({ alternates }) =>\n      alternates.some(a => a.interfaceClass === 255),\n    );\n\n    if (!iface) {\n      throw new TransportInterfaceNotAvailable(\n        \"No WebUSB interface found for your Ledger device. Please upgrade firmware or contact techsupport.\",\n      );\n    }\n\n    const interfaceNumber = iface.interfaceNumber;\n\n    try {\n      await device.claimInterface(interfaceNumber);\n    } catch (e: any) {\n      await device.close();\n      throw new TransportInterfaceNotAvailable(e.message);\n    }\n\n    const transport = new TransportWebUSB(device, interfaceNumber);\n\n    const onDisconnect = e => {\n      if (device === e.device) {\n        // $FlowFixMe\n        navigator.usb.removeEventListener(\"disconnect\", onDisconnect);\n\n        transport._emitDisconnect(new DisconnectedDevice());\n      }\n    };\n\n    // $FlowFixMe\n    navigator.usb.addEventListener(\"disconnect\", onDisconnect);\n    return transport;\n  }\n\n  _disconnectEmitted = false;\n  _emitDisconnect = (e: Error) => {\n    if (this._disconnectEmitted) return;\n    this._disconnectEmitted = true;\n    this.emit(\"disconnect\", e);\n  };\n\n  /**\n   * Release the transport device\n   */\n  async close(): Promise<void> {\n    await this.exchangeBusyPromise;\n    await this.device.releaseInterface(this.interfaceNumber);\n    await gracefullyResetDevice(this.device);\n    await this.device.close();\n  }\n\n  /**\n   * Exchange with the device using APDU protocol.\n   * @param apdu\n   * @returns a promise of apdu response\n   */\n  async exchange(apdu: Buffer): Promise<Buffer> {\n    const b = await this.exchangeAtomicImpl(async () => {\n      const { channel, packetSize } = this;\n      log(\"apdu\", \"=> \" + apdu.toString(\"hex\"));\n      const framing = hidFraming(channel, packetSize);\n      // Write...\n      const blocks = framing.makeBlocks(apdu);\n\n      for (let i = 0; i < blocks.length; i++) {\n        await this.device.transferOut(endpointNumber, blocks[i]);\n      }\n\n      // Read...\n      let result;\n      let acc;\n\n      while (!(result = framing.getReducedResult(acc))) {\n        const r = await this.device.transferIn(endpointNumber, packetSize);\n        // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n        // @ts-ignore\n        const buffer = Buffer.from(r.data.buffer);\n        acc = framing.reduceResponse(acc, buffer);\n      }\n\n      log(\"apdu\", \"<= \" + result.toString(\"hex\"));\n      return result;\n    }).catch(e => {\n      if (e && e.message && e.message.includes(\"disconnected\")) {\n        this._emitDisconnect(e);\n\n        throw new DisconnectedDeviceDuringOperation(e.message);\n      }\n\n      throw e;\n    });\n\n    return b as Buffer;\n  }\n\n  setScrambleKey() {}\n}\n\nasync function gracefullyResetDevice(device: USBDevice) {\n  try {\n    await device.reset();\n  } catch (err) {\n    console.warn(err);\n  }\n}\n"],"names":["hidFraming","buffer","Buffer"],"mappings":"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","x_google_ignoreList":[0,1]}