{"version":3,"file":"lazy-chunk-hid-framing.es.js","sources":["source-mapped://source-mapped/node_modules/@ledgerhq/devices/src/hid-framing.ts"],"sourcesContent":["import { TransportError } from \"@ledgerhq/errors\";\nexport type ResponseAcc =\n  | {\n      data: Buffer;\n      dataLength: number;\n      sequence: number;\n    }\n  | null\n  | undefined;\nconst Tag = 0x05;\n\nfunction asUInt16BE(value) {\n  const b = Buffer.alloc(2);\n  b.writeUInt16BE(value, 0);\n  return b;\n}\n\nconst initialAcc = {\n  data: Buffer.alloc(0),\n  dataLength: 0,\n  sequence: 0,\n};\n\n/**\n *\n */\nconst createHIDframing = (channel: number, packetSize: number) => {\n  return {\n    makeBlocks(apdu: Buffer): Buffer[] {\n      let data = Buffer.concat([asUInt16BE(apdu.length), apdu]);\n      const blockSize = packetSize - 5;\n      const nbBlocks = Math.ceil(data.length / blockSize);\n      data = Buffer.concat([\n        data, // fill data with padding\n        Buffer.alloc(nbBlocks * blockSize - data.length + 1).fill(0),\n      ]);\n      const blocks: Buffer[] = [];\n\n      for (let i = 0; i < nbBlocks; i++) {\n        const head = Buffer.alloc(5);\n        head.writeUInt16BE(channel, 0);\n        head.writeUInt8(Tag, 2);\n        head.writeUInt16BE(i, 3);\n        const chunk = data.slice(i * blockSize, (i + 1) * blockSize);\n        blocks.push(Buffer.concat([head, chunk]));\n      }\n\n      return blocks;\n    },\n\n    reduceResponse(acc: ResponseAcc, chunk: Buffer): ResponseAcc {\n      let { data, dataLength, sequence } = acc || initialAcc;\n\n      if (chunk.readUInt16BE(0) !== channel) {\n        throw new TransportError(\"Invalid channel\", \"InvalidChannel\");\n      }\n\n      if (chunk.readUInt8(2) !== Tag) {\n        throw new TransportError(\"Invalid tag\", \"InvalidTag\");\n      }\n\n      if (chunk.readUInt16BE(3) !== sequence) {\n        throw new TransportError(\"Invalid sequence\", \"InvalidSequence\");\n      }\n\n      if (!acc) {\n        dataLength = chunk.readUInt16BE(5);\n      }\n\n      sequence++;\n      const chunkData = chunk.slice(acc ? 5 : 7);\n      data = Buffer.concat([data, chunkData]);\n\n      if (data.length > dataLength) {\n        data = data.slice(0, dataLength);\n      }\n\n      return {\n        data,\n        dataLength,\n        sequence,\n      };\n    },\n\n    getReducedResult(acc: ResponseAcc): Buffer | null | undefined {\n      if (acc && acc.dataLength === acc.data.length) {\n        return acc.data;\n      }\n    },\n  };\n};\n\nexport default createHIDframing;\n"],"names":["Buffer"],"mappings":"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","x_google_ignoreList":[0]}